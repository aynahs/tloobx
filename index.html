<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>多角色比例模擬器 5.3</title>
    <style>
        :root {
            --primary: #3498db;
            --panel-bg: #ffffff;
            --accent: #e67e22;
            --ground: #7f8c8d;
        }

        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: #f0f3f5; 
            display: flex; margin: 0; padding: 0; 
            height: 100vh; overflow: hidden;
        }

        /* 左側面板 */
        .sidebar {
            width: 360px;
            background: var(--panel-bg);
            padding: 15px;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .char-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .tab {
            padding: 8px 12px;
            background: #eee;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        .tab.active { background: var(--primary); color: white; }
        .btn-add { background: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer; padding: 5px 10px; }

        /* 右側預覽區 */
        .main-view {
            flex-grow: 1;
            background: #d1d8e0;
            background-image: linear-gradient(#ffffff 1px, transparent 1px), linear-gradient(90deg, #ffffff 1px, transparent 1px);
            background-size: 40px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            position: relative;
        }

        .stage {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 80px; /* 底部地平線位置 */
            box-sizing: border-box;
        }

        /* 地平線 */
        .ground-line {
            position: absolute;
            bottom: 80px;
            left: 50px;
            right: 50px;
            height: 2px;
            background: var(--ground);
            z-index: 5;
        }

        /* 高度尺 */
        .ruler {
            position: absolute;
            right: 20px;
            bottom: 80px;
            width: 50px;
            border-right: 2px solid #333;
            z-index: 10;
        }
        .ruler-tick {
            position: absolute;
            right: 0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            font-size: 10px;
            color: #333;
            width: 100%;
        }
        .ruler-tick::after {
            content: "";
            display: inline-block;
            height: 1px;
            background: #333;
            margin-left: 5px;
        }
        .tick-major::after { width: 15px; height: 2px; }
        .tick-minor::after { width: 8px; }

        /* 角色容器 */
        .character-container {
            position: absolute;
            bottom: 80px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            transform-origin: bottom center;
            transition: transform 0.1s ease;
            pointer-events: none;
        }

        .part {
            background-size: 100% 100%;
            background-repeat: no-repeat;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            background-color: rgba(189, 195, 199, 0.8);
            pointer-events: auto;
        }

        .height-label {
            position: absolute;
            bottom: -35px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
            pointer-events: none;
        }

        /* UI 元件 */
        .section { margin-bottom: 15px; padding: 12px; background: #fafafa; border-radius: 8px; border: 1px solid #eee; }
        h4 { margin: 0 0 10px 0; font-size: 14px; border-left: 4px solid var(--primary); padding-left: 8px; display: flex; justify-content: space-between; }
        .row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 12px; }
        .row label { width: 95px; flex-shrink: 0; }
        .row input[type="range"] { flex: 1; cursor: pointer; }
        .val-text { width: 45px; color: var(--primary); font-weight: bold; text-align: right; }
        .percent-row { display: flex; height: 18px; border-radius: 9px; overflow: hidden; margin: 10px 0; background: #ddd; font-size: 9px; line-height: 18px; color: white; text-align: center; }
        .delete-btn { background: #e74c3c; color: white; border: none; padding: 5px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; }
    </style>
</head>
<body>

<div class="sidebar">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0">角色編輯器 5.3</h3>
        <button onclick="resetCurrent()" style="font-size:11px">重置當前</button>
    </div>
    
    <div style="margin: 10px 0;">
        <div class="char-tabs" id="charTabs"></div>
        <button class="btn-add" onclick="addCharacter()">+ 新增角色</button>
    </div>

    <div id="controls" style="display:none">
        <div class="section">
            <h4>基礎配置</h4>
            <div class="row">
                <label>水平位置</label>
                <input type="range" min="-500" max="500" value="0" id="posX" oninput="updateCharBasic('posX', this.value)">
                <span class="val-text" id="v-posX">0</span>
            </div>
            <div class="row">
                <label>當前顯示總高 (cm)</label>
                <input type="range" min="10" max="300" id="totalH" oninput="updateTotalH(this.value)">
                <input type="number" id="totalHNum" style="width:55px" oninput="updateTotalH(this.value)">
            </div>
            <div class="row">
                <label>顯示區塊數</label>
                <input type="range" min="1" max="5" id="visibleCount" oninput="updateVisibleCount(this.value)">
                <span class="val-text" id="v-visible">5</span>
            </div>
        </div>

        <div class="section">
            <h4>佔比分析 (%)</h4>
            <div id="percentBar" class="percent-row"></div>
        </div>

        <div class="section">
            <h4>部位高度 (cm)</h4>
            <div id="heightSliders"></div>
        </div>

        <div class="section">
            <h4>寬度節點 (cm)</h4>
            <div id="widthSliders"></div>
        </div>

        <div class="section">
            <h4>貼圖</h4>
            <div id="imgUploads"></div>
            <button class="delete-btn" style="width:100%; margin-top:15px" onclick="deleteCharacter()">刪除此角色</button>
        </div>
    </div>
</div>

<div class="main-view">
    <div class="stage" id="stage">
        <div class="ground-line"></div>
        <!-- 尺規容器 -->
        <div class="ruler" id="ruler"></div>
    </div>
</div>

<script>
    const partNames = ["頭部", "軀幹", "髖部", "大腿", "小腿"];
    const widthNames = ["頭頂", "頭底", "頸部(軀幹頂)", "腰部", "髖部底", "膝蓋", "腳底"];
    const colors = ["#e74c3c", "#3498db", "#f1c40f", "#2ecc71", "#9b59b6"];

    function createDefaultChar(name) {
        return {
            name: name,
            posX: 0,
            visible: 5,
            heights: [30, 50, 25, 40, 35], 
            widths: [50, 65, 70, 100, 90, 70, 50],
            imgs: [null, null, null, null, null]
        };
    }

    let characters = [createDefaultChar("角色 1")];
    let activeIdx = 0;

    function getVisibleHeight(c) {
        return c.heights.slice(0, c.visible).reduce((a, b) => a + b, 0);
    }

    function init() {
        renderTabs();
        loadControls(); 
        renderStage();
    }

    function renderTabs() {
        const container = document.getElementById('charTabs');
        container.innerHTML = characters.map((c, i) => `
            <div class="tab ${i === activeIdx ? 'active' : ''}" onclick="switchChar(${i})">${c.name}</div>
        `).join('');
    }

    function switchChar(idx) {
        activeIdx = idx;
        renderTabs();
        loadControls();
        renderStage();
    }

    function addCharacter() {
        const newChar = createDefaultChar("角色 " + (characters.length + 1));
        newChar.posX = (characters.length) * 120 - 100; 
        characters.push(newChar);
        activeIdx = characters.length - 1;
        init();
    }

    function deleteCharacter() {
        if(characters.length <= 1) return alert("至少保留一個角色");
        characters.splice(activeIdx, 1);
        activeIdx = 0;
        init();
    }

    function loadControls() {
        const c = characters[activeIdx];
        const visH = getVisibleHeight(c);
        document.getElementById('controls').style.display = 'block';
        document.getElementById('posX').value = c.posX;
        document.getElementById('v-posX').innerText = c.posX;
        document.getElementById('totalH').value = visH;
        document.getElementById('totalHNum').value = Math.round(visH);
        document.getElementById('visibleCount').value = c.visible;
        document.getElementById('v-visible').innerText = c.visible;

        const hDiv = document.getElementById('heightSliders');
        hDiv.innerHTML = c.heights.map((h, i) => `
            <div class="row" style="display: ${i < c.visible ? 'flex' : 'none'}">
                <label>${partNames[i]}</label>
                <input type="range" min="5" max="150" step="0.1" value="${h}" class="h-slider" oninput="adjustPartHeight(${i}, this.value)">
                <span class="val-text">${Math.round(h)}</span>
            </div>
        `).join('');

        const wDiv = document.getElementById('widthSliders');
        wDiv.innerHTML = c.widths.map((w, i) => {
            let show = false;
            if (i <= 1) show = c.visible >= 1; 
            else if (i <= 3) show = c.visible >= 2; 
            else if (i === 4) show = c.visible >= 3; 
            else if (i === 5) show = c.visible >= 4; 
            else if (i === 6) show = c.visible >= 5; 
            return `<div class="row" style="display: ${show ? 'flex' : 'none'}"><label>${widthNames[i]}</label><input type="range" min="5" max="250" value="${w}" class="w-slider" oninput="updateCharWidth(${i}, this.value)"><span class="val-text">${w}</span></div>`;
        }).join('');

        const iDiv = document.getElementById('imgUploads');
        iDiv.innerHTML = partNames.map((name, i) => `<div class="row" style="display: ${i < c.visible ? 'flex' : 'none'}"><label>${name}</label><input type="file" style="font-size:10px" onchange="uploadImg(event, ${i})"></div>`).join('');
        updatePercentBar();
    }

    function syncUISliders() {
        const c = characters[activeIdx];
        const visH = getVisibleHeight(c);
        const hSliders = document.querySelectorAll('.h-slider');
        const hTexts = document.querySelector('#heightSliders').querySelectorAll('.val-text');
        c.heights.forEach((h, i) => {
            if (hSliders[i]) hSliders[i].value = h;
            if (hTexts[i]) hTexts[i].innerText = Math.round(h);
        });
        document.getElementById('totalH').value = visH;
        document.getElementById('totalHNum').value = Math.round(visH);
        updatePercentBar();
    }

    function updateCharBasic(key, val) {
        characters[activeIdx][key] = parseInt(val);
        document.getElementById('v-'+key).innerText = val;
        renderStage();
    }

    function updateVisibleCount(val) {
        characters[activeIdx].visible = parseInt(val);
        loadControls();
        renderStage();
    }

    function adjustPartHeight(idx, newVal) {
        newVal = parseFloat(newVal);
        const c = characters[activeIdx];
        const oldVisH = getVisibleHeight(c);
        c.heights[idx] = newVal;
        const otherVisibleIndices = [];
        for(let i=0; i<c.visible; i++) if(i !== idx) otherVisibleIndices.push(i);
        if(otherVisibleIndices.length > 0) {
            const currentVisSum = getVisibleHeight(c);
            const gap = (oldVisH - currentVisSum) / otherVisibleIndices.length;
            otherVisibleIndices.forEach(oi => {
                c.heights[oi] += gap;
                if(c.heights[oi] < 5) c.heights[oi] = 5;
            });
        }
        syncUISliders();
        renderStage();
    }

    function updateTotalH(val) {
        if(!val || val < 1) return;
        val = parseFloat(val);
        const c = characters[activeIdx];
        const currentVisH = getVisibleHeight(c);
        const ratio = val / currentVisH;
        for(let i=0; i<c.visible; i++) c.heights[i] *= ratio;
        syncUISliders();
        renderStage();
    }

    function updateCharWidth(i, val) {
        characters[activeIdx].widths[i] = parseInt(val);
        const wTexts = document.querySelector('#widthSliders').querySelectorAll('.val-text');
        if(wTexts[i]) wTexts[i].innerText = val;
        renderStage();
    }

    function updatePercentBar() {
        const c = characters[activeIdx];
        const bar = document.getElementById('percentBar');
        const visibleH = c.heights.slice(0, c.visible);
        const sum = getVisibleHeight(c);
        bar.innerHTML = visibleH.map((h, i) => {
            const p = (h / sum * 100).toFixed(1);
            return `<div style="width:${p}%; background:${colors[i]}">${p}%</div>`;
        }).join('');
    }

    function uploadImg(e, partIdx) {
        const file = e.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                characters[activeIdx].imgs[partIdx] = ev.target.result;
                renderStage();
            };
            reader.readAsDataURL(file);
        }
    }

    function renderStage() {
        const stage = document.getElementById('stage');
        // 清除舊的角色容器
        const oldChars = stage.querySelectorAll('.character-container');
        oldChars.forEach(el => el.remove());

        const SCALE_BASE = 2.5;
        let maxDisplayH = 0;

        // 計算最大顯示高度用於縮放
        characters.forEach(c => {
            const h = getVisibleHeight(c) * SCALE_BASE;
            if(h > maxDisplayH) maxDisplayH = h;
        });

        const stageAvailableH = stage.clientHeight - 160;
        const globalScale = maxDisplayH > stageAvailableH ? stageAvailableH / maxDisplayH : 1;

        // 渲染角色
        characters.forEach((c, charIdx) => {
            const charDiv = document.createElement('div');
            charDiv.className = 'character-container';
            charDiv.style.left = `calc(50% + ${c.posX}px)`;
            charDiv.style.zIndex = charIdx;
            charDiv.style.transform = `scale(${globalScale})`;

            for(let i=0; i<c.visible; i++) {
                const part = document.createElement('div');
                part.className = 'part';
                let tw, bw;
                if(i === 0) { tw = c.widths[0]; bw = c.widths[1]; }
                else { tw = c.widths[i+1]; bw = c.widths[i+2]; }
                const maxW = Math.max(tw, bw);
                const hPx = c.heights[i] * SCALE_BASE;
                part.style.width = (maxW * SCALE_BASE) + 'px';
                part.style.height = hPx + 'px';
                if(c.imgs[i]) part.style.backgroundImage = `url(${c.imgs[i]})`;
                else part.style.backgroundColor = colors[i];
                const tP = ((maxW - tw) / 2 / maxW) * 100;
                const bP = ((maxW - bw) / 2 / maxW) * 100;
                part.style.clipPath = `polygon(${tP}% 0%, ${100-tP}% 0%, ${100-bP}% 100%, ${bP}% 100%)`;
                charDiv.appendChild(part);
            }

            const label = document.createElement('div');
            label.className = 'height-label';
            label.innerText = `${Math.round(getVisibleHeight(c))} cm`;
            charDiv.appendChild(label);
            stage.appendChild(charDiv);
        });

        // 渲染尺規
        renderRuler(globalScale * SCALE_BASE);
    }

    function renderRuler(pxPerCm) {
        const ruler = document.getElementById('ruler');
        ruler.innerHTML = '';
        const MAX_RULER_H = 300; // 尺規最大 300cm
        
        for (let h = 0; h <= MAX_RULER_H; h += 10) {
            const tick = document.createElement('div');
            const isMajor = h % 50 === 0;
            tick.className = `ruler-tick ${isMajor ? 'tick-major' : 'tick-minor'}`;
            tick.style.bottom = (h * pxPerCm) + 'px';
            if (isMajor) {
                tick.innerHTML = `<span>${h}</span>`;
            }
            ruler.appendChild(tick);
        }
    }

    function resetCurrent() {
        const name = characters[activeIdx].name;
        characters[activeIdx] = createDefaultChar(name);
        init();
    }

    window.onresize = renderStage;
    init();
</script>

</body>
</html>

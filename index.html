<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ¯”ä¾‹å·¥å…·</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Micro+5&display=swap" rel="stylesheet">

    <style> 
 :root {
     --primary: #3498db;
     --panel-bg: #ffffff;
     --accent: #e67e22;
     --ruler-color: #555;
     /* å®šç¾©æ–°çš„æ¯”ä¾‹ï¼š1cm = 3.5px (200cm = 700px) */
     --scale-factor: 3.5;
 }
 body {
     font-family: "Micro 5", "DotGothic16", sans-serif;
     font-size: 16px;
     font-size-adjust: 0.5;
     background: #f0f3f5;
     display: flex;
     margin: 0;
     padding: 0;
     height: 100vh;
     overflow: hidden;
 }
 /* å·¦å´æ§åˆ¶é¢æ¿ */

 .sidebar {
     position: absolute;
     height: auto;
     width: 250px;
     left: 15px;
     top: 15px;
     max-height: 90%;
     background: #DCD;
     padding: 15px;
     overflow-y: auto;
     display: flex;
     flex-direction: column;
     z-index: 100;
scrollbar-width: none;
 }
 .char-tabs {
     display: flex;
     gap: 5px;
     margin-bottom: 15px;
     overflow-x: auto;
     padding-bottom: 5px;
 /* æ²è»¸-Firefox */
scrollbar-width: thin;
scrollbar-color: #000077 #bada55;
 }
 .tab {
     padding: 8px 12px;
     background: #eee;
     border-radius: 5px;
     cursor: pointer;
     white-space: nowrap;
 }
 .tab.active {
     background: var(--primary);
     color: white;
 }
 button {
     font-family: "Micro 5", "DotGothic16";
     padding: 6px 12px;
     cursor: pointer;
     border: none;
     border-radius: 4px;
     background: #95a5a6;
     color: white;
 }
 button.a {
     background: #2ecc71;
 }
 button.d {
     background: #e74c3c;
 }
 button.r {
     background: #e74c3c;
 }
 button:hover {
     background: #fff;
 }
 /* å³å´ç¹ªåœ–å€ */

 .main-view {
     width: 100vw;
     height: 100vh;
     background: #d1d8e0;
     background-image: linear-gradient(#ffffff 1px, transparent 1px), linear-gradient(90deg, #ffffff 1px, transparent 1px);
     background-size: 40px 40px;
     display: flex;
     flex-direction: column;
     align-items: center;
     justify-content: flex-end;
     padding-bottom: 60px;
     position: relative;
     z-index: 1;
 }
 .stage {
     position: relative;
     width: 100%;
     height: 100%;
     display: flex;
     justify-content: center;
     align-items: flex-end;
 }
 /* æ¨™å°ºå®¹å™¨ (200cm åŸºæº–) */

 .ruler-container {
     position: absolute;
     right: 10px;
     bottom: 60px;
     width: 100%;
     height: 700px;
     /* 200cm * 3.5 */
     transform-origin: bottom right;
     pointer-events: none;
     z-index: 5;
 }
 /*
 .ruler-container::after {
    border-bottom: 1px solid red;
    content: '';
    position: absolute;
    right: 80px;
    width: 100%;
    height: 1px;
    bottom: 0px;
    background: red;
 }
*/

 .horiz {
     position: absolute;
     bottom: 60px;
     right: 80px;
     width: 100%;
     /* å€å¡Šå¯¬åº¦ */
     height: 0.8px;
     /* å€å¡Šé«˜åº¦ */
     background: red;
     z-index: 3;
     /* æ”¾åœ¨æ–‡å­—ä¸‹æ–¹ */
     pointer-events: none;
 }
 .ruler {
     width: 100%;
     height: 100%;
     position: relative;
     /* 10cm = 35px, 50cm = 175px */
     background-image: 
     repeating-linear-gradient(0deg, var(--ruler-color) 0 1px, transparent 0 35px), 
     repeating-linear-gradient(0deg, var(--ruler-color) 0 2px, transparent 0 175px);
     background-size: 5px, 15px;
     background-repeat: no-repeat;
     background-position: right top;
     display: flex;
     flex-direction: column-reverse;
     justify-content: space-between;
     counter-reset: ruler-val -50;
 }

 /* æ•¸å­—æ¨™ç±¤ç¯€é» */
 .ruler div {
     counter-increment: ruler-val 50;
     position: relative;
     width: 100%;
     height: 0;
 }

 /* é¡¯ç¤ºæ•¸å­—æ–‡å­— */
 .ruler div::before {
     content: counter(ruler-val);
     position: absolute;
     right: 35px;
     bottom: -0.6em;
     color: var(--ruler-color);
     text-align: right;
     width: 30px;
 }

 /* è§’è‰²ä½ç½® */
 .character-container {
     position: absolute;
     bottom: 60px;
     display: flex;
     flex-direction: column;
     align-items: center;
     transform-origin: bottom center;
     transform: translateX(-50%) scale(1);
     pointer-events: none;
 }
 .part {
     background-size: 100% 100%;
     background-repeat: no-repeat;
     background-position: center;
     display: flex;
     align-items: center;
     justify-content: center;
     color: white;
     font-weight: bold;
     text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
     background-color: rgba(189, 195, 199, 0.8);
     pointer-events: auto;
 }
 /*ä¸‹æ–¹é«˜åº¦æ¨™ç±¤*/

 .height-label {
     position: absolute;
     bottom: -35px;
     background: rgba(0, 0, 0, 0.6);
     color: white;
     padding: 2px 12px;
     border-radius: 10px;
     white-space: nowrap;
     pointer-events: none;
 }
 .section {
     margin-bottom: 15px;
     padding: 12px;
     background: #fafafa;
     border-radius: 8px;
     border: 1px solid #eee;
 }
 h4 {
     margin: 0 0 10px 0;
     border-left: 4px solid var(--primary);
     padding-left: 8px;
 }
 .row {
     display: flex;
     align-items: center;
     gap: 8px;
     margin-bottom: 8px;
 }
 .row label {
     width: 15%;
     font-weight: bold;
 }
 input[type="range"] {
     flex: 1;
 }
 .val-text {
     width: 10%;
     color: var(--primary);
     text-align: right;
 }
 .percent-row {
     display: flex;
     height: 18px;
     border-radius: 9px;
     overflow: hidden;
     margin: 10px 0;
     background: #ddd;
     line-height: 18px;
     color: white;
     text-align: center;
 }
 /*=================================================== */


 /* æ•¸å­—è¼¸å…¥æ¡†*/

 input[type=number] {
     border: 0px;
     background-color: #2c3e50;
     color: #ecf0f1;
     padding: 0px 10px;
     border-radius: 4px;
     font-family: "Micro 5";
     font-size: 20px;
     width: 20px;
     -moz-appearance: textfield;
 }
 /* æ»‘æ¡¿æ¨£å¼ */

 input[type="range"] {
     width: 100%;
 }
 /* æ»‘æ¡¿è»Œé“-Firefox */

 input[type="range"]::-moz-range-track {
     background: #34495e;
     height: 6px;
     border-radius: 0px;
 }
 /* æ»‘æ¡¿æ§åˆ¶ç´ (åœ“é») - Firefox */

 input[type="range"]::-moz-range-thumb {
     border-radius: 0px;
     background-color: #3498db;
     height: 24px;
     width: 14px;
     border: none;
 }
 /* -æª”æ¡ˆä¸Šå‚³æŒ‰éˆ•æ¨£å¼ */

 input[type="file"]::file-selector-button {
     background-color: #34495e;
     color: white;
     padding: 6px 12px;
     border-radius: 4px;
     border: none;
     cursor: pointer;
     transition: background 0.3s;
     font-size: 12px;
     margin-right: 10px;
 }

 </style>
</head>

  <!-- ================================================ -->

<body>
   <div class="sidebar">
      <details open="">
         <summary>
            æ¯”ä¾‹å·¥å…·
         </summary>
         <div style="margin: 10px 0;">
            <div class="char-tabs" id="charTabs"></div><button class="a" onclick="addCharacter()">âœšæ–°å¢</button> <button class="d" onclick="deleteCharacter()">âœ–åˆªé™¤</button> <button class="r" onclick="resetCurrent()">â­¯é‡ç½®</button>
         </div>
         <div id="controls" style="display:none">
            <div class="section">
               <div class="row">
                  <label>ä½ç½®</label> <input id="posX" max="800" min="-800" oninput="updateCharBasic('posX', this.value)" type="range" value="0"> <span class="val-text" id="v-posX">0</span>
               </div>
            </div>
            <div class="section">
               <div class="row">
                  <label>ç¸½é«˜</label> <input id="totalH" max="300" min="10" oninput="updateTotalH(this.value)" type="range"> <input id="totalHNum" oninput="updateTotalH(this.value)" type="number">cm
               </div>
               <div class="row">
                  <label>å€å¡Š</label> <input id="visibleCount" max="5" min="1" oninput="updateVisibleCount(this.value)" type="range"> <span class="val-text" id="v-visible">5</span>
               </div>
               <div class="percent-row" id="percentBar"></div>
               <div id="heightSliders"></div>
            </div>
            <div class="section">
               <div id="widthSliders"></div>
            </div>
            <div class="section">
               <div id="imgUploads"></div>
            </div>
         </div>
      </details>
   </div>
<div class="horiz"></div>
   <div class="main-view">
      <div class="stage" id="stage">
         <!-- å°ºè¦(æ¯é–“éš”0, 50, 100, 150, 200) -->
         <div class="ruler-container" id="rulerContainer">

            <div class="ruler">
               <div></div>
               <div></div>
               <div></div>
               <div></div>
               <div></div>
            </div>
         </div>
      </div>
   </div>


  <!-- ================================================ -->

 <script>
    /* å®šç¾©å…¨åŸŸå¸¸æ•¸ */
    const partNames = ["ğŸ„·", "ğŸ…ƒ", "ğŸ„°", "ğŸ„¿", "ğŸ„»"];
    const widthNames = ["ğŸ„·â–´", "ğŸ„·â–¾", "ğŸ…ƒâ–´", "ğŸ…ƒğŸ„°", "ğŸ„°ğŸ„¿", "ğŸ„¿ğŸ„»", "ğŸ„»â–¾"];
    const colors = ["#0D2744", "#53728A", "#7691AD", "#B9CFDD", "#FF929A"];
    const SCALE_BASE = 3.5; // 1cm = 3.5px

    /* åˆå§‹åŒ–è§’è‰²æ•¸æ“šï¼šé«˜åº¦æ”¹ç‚ºç™¾åˆ†æ¯”(sum=100)ï¼Œæ–°å¢ targetH ç´€éŒ„å¯¦éš›èº«é«˜ */
    function createDefaultChar(name) {
        return {
            name: name,
            posX: 0,
            visible: 5,
            targetH: 180, // å¯¦éš›èº«é«˜ (cm)
            heights: [14, 14, 11, 11, 50], // å„éƒ¨ä½ä½”æ¯” (%)ï¼Œç¸½å’Œé ˆç‚º 100
            widths: [25, 25, 45, 40, 30, 40, 20], // å¯¬åº¦ (ç›¸å°å–®ä½ 1-100)
            imgs: [null, null, null, null, null]
        };
    }

    let characters = [createDefaultChar("1")];
    let activeIdx = 0;

    /* åˆå§‹åŒ– */
    function init() {
        renderTabs();
        loadControls();
        renderStage();
    }

    function renderTabs() {
        const container = document.getElementById('charTabs');
        container.innerHTML = characters.map((c, i) => `
            <div class="tab ${i === activeIdx ? 'active' : ''}" onclick="switchChar(${i})">${c.name}</div>
        `).join('');
    }

    function switchChar(idx) {
        activeIdx = idx;
        init();
    }

    function addCharacter() {
        const newChar = createDefaultChar("" + (characters.length + 1));
        newChar.posX = (characters.length) * 80;
        characters.push(newChar);
        activeIdx = characters.length - 1;
        init();
    }

    function deleteCharacter() {
        if (characters.length <= 1) return;
        characters.splice(activeIdx, 1);
        activeIdx = 0;
        init();
    }

    /* è¼‰å…¥æ§åˆ¶é …ï¼šç¯„åœçµ±ä¸€ç‚º 1~100 */
   
   
   
   
   
   
   
 function loadControls() {
    const c = characters[activeIdx];
    document.getElementById('controls').style.display = 'block';
    document.getElementById('posX').value = c.posX;
    document.getElementById('v-posX').innerText = c.posX;
    
    document.getElementById('totalH').value = c.targetH;
    document.getElementById('totalHNum').value = Math.round(c.targetH);
    
    document.getElementById('visibleCount').value = c.visible;
    document.getElementById('v-visible').innerText = c.visible;

    // é«˜åº¦æ»‘æ¡¿ï¼šå¾ç™¾åˆ†æ¯”æ”¹ç‚º cm
    const hDiv = document.getElementById('heightSliders');
    hDiv.innerHTML = c.heights.map((h, i) => {
        const cmVal = (h / 100 * c.targetH).toFixed(1); // è¨ˆç®—ç•¶å‰ cm
        return `
            <div class="row" style="display: ${i < c.visible ? 'flex' : 'none'}">
                <label>${partNames[i]}</label>
                <input type="range" 
                    min="1" 
                    max="${c.targetH}" 
                    step="0.1" 
                    value="${cmVal}" 
                    class="h-slider" 
                    oninput="adjustPartHeightCM(${i}, this.value)">
                <span class="val-text">${cmVal} cm</span>
            </div>
        `;
    }).join('');
      
      
   
   
   
   
   
   
  
      
      

        // å¯¬åº¦æ»‘æ¡¿ (1-100)
        const wDiv = document.getElementById('widthSliders');
        wDiv.innerHTML = c.widths.map((w, i) => {
            let show = (i <= 1 && c.visible >= 1) || (i <= 3 && c.visible >= 2) || (i === 4 && c.visible >= 3) || (i === 5 && c.visible >= 4) || (i === 6 && c.visible >= 5);
            return `
                <div class="row" style="display: ${show ? 'flex' : 'none'}">
                    <label>${widthNames[i]}</label>
                    <input type="range" min="1" max="100" value="${w}" class="w-slider" oninput="updateCharWidth(${i}, this.value)">
                    <span class="val-text">${w}</span>
                </div>
            `;
        }).join('');

        const iDiv = document.getElementById('imgUploads');
        iDiv.innerHTML = partNames.map((name, i) => `
            <div class="row" style="display: ${i < c.visible ? 'flex' : 'none'}">
                <label>${name}</label><input type="file" style="font-size:10px" onchange="uploadImg(event, ${i})">
            </div>
        `).join('');
        updatePercentBar();
    }
   
   
   
   
   
         function adjustPartHeightCM(idx, newValCm) {
    const c = characters[activeIdx];
    // å°‡è¼¸å…¥çš„ cm è½‰å›ç™¾åˆ†æ¯” (ä¾‹å¦‚: 45cm / 180cm * 100 = 25%)
    const newValPercent = (parseFloat(newValCm) / c.targetH) * 100;
    
    // å‘¼å«åŸæœ¬è™•ç†ç™¾åˆ†æ¯”åˆ†é…çš„é‚è¼¯
    adjustPartHeight(idx, newValPercent);
}
    
   
   

function syncUISliders() {
    const c = characters[activeIdx];
    const hSliders = document.querySelectorAll('.h-slider');
    const hTexts = document.querySelector('#heightSliders').querySelectorAll('.val-text');
    
    c.heights.forEach((h, i) => {
        const cmVal = (h / 100 * c.targetH).toFixed(1);
        if (hSliders[i]) {
            hSliders[i].value = cmVal;
            hSliders[i].max = c.targetH; // ç¢ºä¿ max éš¨ç¸½èº«é«˜æ›´æ–°
        }
        if (hTexts[i]) hTexts[i].innerText = cmVal + ' cm';
    });
    updatePercentBar();
}

    function updateCharBasic(key, val) {
        characters[activeIdx][key] = parseInt(val);
        document.getElementById('v-' + key).innerText = val;
        renderStage();
    }

    function updateVisibleCount(val) {
        characters[activeIdx].visible = parseInt(val);
        // ç•¶å¯è¦‹éƒ¨ä½æ”¹è®Šï¼Œéœ€é‡æ–°åˆ†é…ç™¾åˆ†æ¯”ç¢ºä¿ç¸½å’Œç‚º 100
        const c = characters[activeIdx];
        const avg = 100 / c.visible;
        for(let i=0; i<5; i++) c.heights[i] = (i < c.visible) ? avg : 0;
        loadControls();
        renderStage();
    }

    /* èª¿æ•´é«˜åº¦æ¯”ä¾‹ï¼šç¢ºä¿å¯è¦‹éƒ¨ä½ç¸½å’Œæ°¸é ç‚º 100% */
    function adjustPartHeight(idx, newVal) {
        newVal = parseFloat(newVal);
        const c = characters[activeIdx];
        const minVal = 1;
        
        // é™åˆ¶æœ€å¤§å€¼ï¼Œç¢ºä¿å…¶ä»–éƒ¨ä½è‡³å°‘æœ‰ 1%
        const maxLimit = 100 - (c.visible - 1) * minVal;
        if (newVal > maxLimit) newVal = maxLimit;
        if (newVal < minVal) newVal = minVal;

        const oldVal = c.heights[idx];
        const delta = newVal - oldVal;
        const otherIndices = [];
        for (let i = 0; i < c.visible; i++) {
            if (i !== idx) otherIndices.push(i);
        }

        if (otherIndices.length > 0) {
            c.heights[idx] = newVal;
            const otherSum = otherIndices.reduce((sum, i) => sum + c.heights[i], 0);
            
            otherIndices.forEach((oi) => {
                const ratio = otherSum > 0 ? c.heights[oi] / otherSum : 1 / otherIndices.length;
                c.heights[oi] -= delta * ratio;
                if (c.heights[oi] < minVal) c.heights[oi] = minVal;
            });

            // ä¿®æ­£å¾®å°èª¤å·®ç¢ºä¿ç¸½å’Œå¿…ç‚º 100
            const currentTotal = c.heights.slice(0, c.visible).reduce((a, b) => a + b, 0);
            const error = 100 - currentTotal;
            c.heights[otherIndices[otherIndices.length - 1]] += error;
        }
        syncUISliders();
        renderStage();
    }

    /* æ›´æ–°ç¸½èº«é«˜ï¼šç¾åœ¨åªæ”¹æ•¸å€¼ï¼Œä¸å½±éŸ¿éƒ¨ä½æ¯”ä¾‹ */
function updateTotalH(val) {
    if (val === "" || isNaN(val) || val <= 0) return;
    characters[activeIdx].targetH = parseFloat(val);
    document.getElementById('totalH').value = val;
    document.getElementById('totalHNum').value = Math.round(val);
    
    // é—œéµï¼šé‡æ–°åŠ è¼‰æ§åˆ¶é …ä»¥æ›´æ–°æ»‘æ¡¿çš„ max å€¼èˆ‡ cm é¡¯ç¤º
    loadControls(); 
    renderStage();
}

    function updateCharWidth(i, val) {
        characters[activeIdx].widths[i] = parseInt(val);
        const wTexts = document.querySelector('#widthSliders').querySelectorAll('.val-text');
        if (wTexts[i]) wTexts[i].innerText = val;
        renderStage();
    }

    function updatePercentBar() {
        const c = characters[activeIdx];
        const bar = document.getElementById('percentBar');
        bar.innerHTML = c.heights.slice(0, c.visible).map((h, i) => {
            return `<div style="width:${h}%; background:${colors[i]}">${Math.round(h)}%</div>`;
        }).join('');
    }

    function uploadImg(e, partIdx) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                characters[activeIdx].imgs[partIdx] = ev.target.result;
                renderStage();
            };
            reader.readAsDataURL(file);
        }
    }

function renderStage() {
    const stage = document.getElementById('stage');
    let maxDisplayH = 0;
    
    // 1. æ¸…é™¤èˆŠæœ‰çš„è§’è‰²å®¹å™¨èˆ‡æ¨™ç±¤
    const containers = stage.querySelectorAll('.character-container');
    const labels = stage.querySelectorAll('.height-label');
    containers.forEach(el => el.remove());
    labels.forEach(el => el.remove());

    const WIDTH_REF_H = 180;

    // 2. ç¬¬ä¸€æ¬¡è¨ˆç®—ï¼šæ‰¾å‡ºæ‰€æœ‰è§’è‰²çš„æœ€é«˜å€¼ä»¥æ±ºå®šå…¨åŸŸç¸®æ”¾æ¯”ä¾‹
    characters.forEach((c) => {
        let charHPx = 0;
        for (let i = 0; i < c.visible; i++) {
            charHPx += (c.heights[i] / 100) * c.targetH * SCALE_BASE;
        }
        if (charHPx > maxDisplayH) maxDisplayH = charHPx;
    });

    const stageH = stage.clientHeight - 120;
    const scale = maxDisplayH > stageH ? stageH / maxDisplayH : 1;

    // 3. ç¬¬äºŒæ¬¡è¨ˆç®—ï¼šæ¸²æŸ“è§’è‰²èˆ‡ç¨ç«‹æ¨™ç±¤
    characters.forEach((c, charIdx) => {
        const charDiv = document.createElement('div');
        charDiv.className = 'character-container';
        charDiv.style.left = `calc(50% + ${c.posX}px)`;
        charDiv.style.zIndex = charIdx;
        charDiv.style.transform = `translateX(-50%) scale(${scale})`; // è§’è‰²ä¾æ¯”ä¾‹ç¸®æ”¾

        const widthScale = c.targetH / WIDTH_REF_H;
        for (let i = 0; i < c.visible; i++) {
            const part = document.createElement('div');
            part.className = 'part';
            let tw = ((i === 0) ? c.widths[0] : c.widths[i + 1]) * widthScale;
            let bw = ((i === 0) ? c.widths[1] : c.widths[i + 2]) * widthScale;
            const maxW = Math.max(tw, bw);
            const hPx = (c.heights[i] / 100) * c.targetH * SCALE_BASE;
            
            part.style.width = (maxW * SCALE_BASE) + 'px';
            part.style.height = hPx + 'px';

            if (c.imgs[i]) {
                part.style.background = `url(${c.imgs[i]}) no-repeat center/cover transparent`;
            } else {
                part.style.background = `${colors[i]}`;
            }

            const tP = ((maxW - tw) / 2 / maxW) * 100;
            const bP = ((maxW - bw) / 2 / maxW) * 100;
            part.style.clipPath = `polygon(${tP}% 0%, ${100-tP}% 0%, ${100-bP}% 100%, ${bP}% 100%)`;
            
            charDiv.appendChild(part);
        }
        stage.appendChild(charDiv);

        // --- å»ºç«‹é«˜åº¦æ¨™ç±¤ (æ”¾åœ¨è§’è‰²ä¸‹æ–¹) ---
        const label = document.createElement('div');
        label.className = 'height-label';
        label.innerText = `${Math.round(c.targetH)} cm`;
        
        // é—œéµå®šä½ï¼š
        // 1. æ°´å¹³èˆ‡è§’è‰²åŒæ­¥
        label.style.left = `calc(50% + ${c.posX}px)`;
        label.style.transform = `translateX(-50%)`; // åªåšä½ç§»ä¿®æ­£ï¼Œä¸è·Ÿéš¨ scale
        
        // 2. å‚ç›´å®šä½åœ¨èˆå°åº•éƒ¨ (å‡è¨­è…³åº•åŸºæº–ç·šåœ¨ bottom: 60pxï¼Œæ¨™ç±¤æ”¾æ›´ä½)
        label.style.bottom = '20px'; 
        label.style.position = 'absolute';

        stage.appendChild(label);
    });

    document.getElementById('rulerContainer').style.transform = `scale(${scale})`;
}  

    function resetCurrent() {
        const name = characters[activeIdx].name;
        characters[activeIdx] = createDefaultChar(name);
        init();
    }

    window.onresize = renderStage;
    init();
</script>
</body>
</html>

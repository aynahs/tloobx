<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>比例工具</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Micro+5&display=swap" rel="stylesheet">

    <style> 
 :root {
     --primary: #3498db;
     --panel-bg: #ffffff;
     --accent: #e67e22;
     --ruler-color: #555;
     /* 定義新的比例：1cm = 3.5px (200cm = 700px) */
     --scale-factor: 3.5;

 --cor01: rgb(255, 255, 255);
 --cor02: rgb(255, 255, 255);
 --cor03: rgb(255, 255, 255);
--cor04: rgb(255, 255, 255);
--cor05: rgb(255, 255, 255);

/*  var(--cor05)  */

 }
 body {
     font-family: "Micro 5", "LINE Seed JP", sans-serif;
 
     font-size: 18px;
     font-size-adjust: 0.5;


     /* ----------- */
	background-image: radial-gradient(#fff 2px, transparent 2px);
	background-size: 35px 35px;
	background-color: #E4E4ED;
 /* ----------- */
     display: flex;
     margin: 0;
     padding: 0;
     height: 100vh;
     overflow: hidden;
 }


 /* 左側選單 */

 .sidebar {
     position: absolute;
     height: auto;
     width: 250px;
     left: 15px;
     top: 15px;
     max-height: 95%;
    
     padding: 0px;
     overflow-y: auto;
     display: flex;
     flex-direction: column;
     z-index: 100;
scrollbar-width: none;

background:   linear-gradient(to right, DarkCyan 6%, DarkGray 6%);

border: 2px red dotted;
 }


 summary{
background: #5F9EA0;
}

/* 展開後 summary 的邊框顏色 */
details[open] summary {
  background: #f9f9f9;
}



 .char-tabs {
     display: flex;
     gap: 5px;
     margin-bottom: 0px;
     overflow-x: auto;
     padding-bottom: 0px;
 /* 捲軸-Firefox */
scrollbar-width: thin;
scrollbar-color: #000077 #bada55;

border: 2px red dotted;

 }
 .tab {
     padding: 0px 0px;
     background: #eee;
     border-radius: 5px;
     cursor: pointer;
     white-space: nowrap;

border: 2px red dotted;
 }
 .tab.active {
     background: var(--primary);
     color: white;

border: 2px red dotted;
 }
 button {
     font-family: "Micro 5";

     
     font-size-adjust: 0.5;

     padding: 0px;
     cursor: pointer;
     border: none;
     border-radius: 0px;
     
     color: white;
   height: 40px;
width: 40px;
 }
 button.a {
     background: #2ecc71;
 }
 button.d {
     background: #e74c3c;
 }
 button.r {
     background: #e74c3c;
 }
 button:hover {
     filter: grayscale(80%);
 }



 /* 右側繪圖區 */
 .main-view {
     width: 100vw;
     height: 100vh;

     display: flex;
     flex-direction: column;
     align-items: center;
     justify-content: flex-end;
     padding-bottom: 0px;
     position: relative;
     z-index: 1;



 }
 .stage {
     position: relative;
     width: 100%;
     height: 100%;
     display: flex;
     justify-content: center;
     align-items: flex-end;


 }
 /* 標尺容器 (200cm 基準) */

 .rulerbox {
     position: absolute;
     right: 10px;
     bottom: 60px;
     width: 100%;
     height: 700px;
     /* 200cm * 3.5 */
     transform-origin: bottom right;
     pointer-events: none;
     z-index: 5;
 }


   .horiz {
     position: absolute;
     bottom: 60px;
     right: 80px;
     width: 100%;
     height: 0.8px;
     background: red;
     z-index: 1;
     pointer-events: none;
 }    
     
      
      
      
 .ruler {
     width: 100%;
     height: 100%;
     position: relative;
     /* 10cm = 35px, 50cm = 175px */
     background-image: 
     repeating-linear-gradient(0deg, var(--ruler-color) 0 1px, transparent 0 35px), 
     repeating-linear-gradient(0deg, var(--ruler-color) 0 2px, transparent 0 175px);
     background-size: 5px, 15px;
     background-repeat: no-repeat;
     background-position: right top;
     display: flex;
     flex-direction: column-reverse;
     justify-content: space-between;
     counter-reset: ruler-val -50;
 }

 /* 數字標籤節點 */
 .ruler div {
     counter-increment: ruler-val 50;
     position: relative;
     width: 100%;
     height: 0;
 }

 /* 顯示數字文字 */
 .ruler div::before {
     content: counter(ruler-val);
     position: absolute;
     right: 35px;
     bottom: -0.6em;
     color: var(--ruler-color);
     text-align: right;
     width: 30px;
 }

 /* 角色位置 */
 .character-container {
     position: absolute;
     bottom: 60px;
     display: flex;
     flex-direction: column;
     align-items: center;
     transform-origin: bottom center;
     transform: translateX(-50%) scale(1);
     pointer-events: none;
 }

 /* 肖像區塊 */
 .part {
     pointer-events: auto;
 }

 /*下方高度標籤*/

 .height-label {
     position: absolute;
     bottom: -35px;
     background: rgba(0, 0, 0, 0.6);
     color: white;
     padding: 0px 0px;
     border-radius: 10px;
     white-space: nowrap;
     pointer-events: none;
 }

    /*   ------------------------------ */

 /* 段落區塊 */
 .section {
     margin-bottom: 0px;
     padding: 5px 10px 5px 20px;
     background: -;
     border-radius: 0px;
     
border: 2px Coral dotted;

 }

 /* 每一橫 */
 .row {
     display: flex;
     align-items: center;
     gap: 8px;
     
height: 20px;
    border: px Blue dotted;
 }
 .row label {
     width: 15%;
        

 
 }
 input[type="range"] {
     flex: 1;
 }
 .val-text {
     width: 15%;
     color: fff;
     text-align: right;
 }

/* 百分比列 */

 .percent-row {
     display: flex;
     height: 24px;
     border-radius: 0px;
     overflow: hidden;
     margin: 10px 0;
     
     line-height: 24px;
     color: white;
     text-align: center;
 }
 /*=================================================== */


 /* 數字輸入框*/

 input[type=number] {
     border: 0px;
     background-color: #2c3e50;
     color: #ecf0f1;
     padding: 0px 10px;
     border-radius: 4px;
     font-family: "Micro 5";
     font-size: 20px;
     width: 20px;
     -moz-appearance: textfield;
 }
 /* 滑桿樣式 */

 input[type="range"] {
     width: 100%;
background: transparent;
 }
 /* 滑桿軌道-Firefox */

 input[type="range"]::-moz-range-track {
     background: #34495e;
     height: 6px;
     border-radius: 0px;
 }
 /* 滑桿控制紐 (圓點) - Firefox */

 input[type="range"]::-moz-range-thumb {
     border-radius: 0px;
     background-color: #3498db;
     height: 15px;
     width: 15px;
     border: none;
 }
 /* -檔案上傳按鈕樣式 */

 input[type="file"]::file-selector-button {
     background-color: #34495e;
     color: white;
     padding: 2px 10px;
     border-radius: 4px;
     border: none;
     cursor: pointer;
     transition: background 0.3s;
  
     margin-right: 10px;
 
   
 }




 </style>
</head>

  <!-- ================================================ -->

<body>
 <div class="sidebar">
    <details open>
        <summary> HTAPL </summary>

 <div class="section">

        <div class="char-tabs" id="charTabs"></div>
</div>
         <div class="section">
            <button type="button" class="a" onclick="addPort()">✚ Ad</button>
            <button type="button" class="d" onclick="delPort()">✖ Ðe</button>
            <button type="button" class="r" onclick="retPort()">@ Re</button>
     
</div>



<div class="section">
        
        <div id="controls" style="display:none">
            <div class="row">
                <label for="posX">Hori</label>
                <input id="posX" max="800" min="-800" oninput="updateCharBasic('posX', this.value); document.getElementById('v-posX').textContent = this.value" type="range" value="0">
                <span class="val-text" id="v-posX">0</span>
            </div>

            <div class="row">
                <label for="totalH">TolH</label>              
                <input id="totalH" max="300" min="10" oninput="updateTotalH(this.value); document.getElementById('totalHNum').value = this.value" type="range">
                <input id="totalHNum" oninput="updateTotalH(this.value); document.getElementById('totalH').value = this.value" type="number"> cm
            </div>

            <div class="row">
                <label for="visibleCount">Part</label>
                <input id="visibleCount" max="5" min="1" oninput="updateVisibleCount(this.value); document.getElementById('v-visible').textContent = this.value" type="range" value="5">
                <span class="val-text" id="v-visible">5</span>
            </div>


            <div class="percent-row" id="percentBar"></div>


            <div id="heightSliders"></div>
            <hr>
            <div id="widthSliders"></div>
            <hr>
            <div id="imgUploads"></div>
          
       
   </div>

        </div> 
   <div class="section"></div>
    </details>
</div>


<div class="horiz"></div>
   <div class="main-view">
      <div class="stage" id="stage">
         <!-- 尺規(每間隔0, 50, 100, 150, 200) -->
         <div class="rulerbox" id="rulerbox" >
            <div class="ruler">
               <div></div>
               <div></div>
               <div></div>
               <div></div>
               <div></div>
            </div>
         </div>
      </div>
   </div>


  <!-- ================================================ -->

 <script>
    /* 定義全域常數 */
    const partNames = ["H", "T", "A", "P", "L"];
    const widthNames = ["H▴", "H▾", "T▴", "TA", "AP", "PL", "L▾"];
    const colors = ["#0D2744", "#53728A", "#7691AD", "#B9CFDD", "#ff7982"];
    const SCALE_BASE = 3.5; // 1cm = 3.5px

    /* 初始化角色數據：高度改為百分比(sum=100)，新增 targetH 紀錄實際身高 */
    function createDefaultChar(name) {
        return {
            name: name,
            posX: 0,
            visible: 5,
            targetH: 180, // 實際身高 (cm)
            heights: [14, 14, 11, 11, 50], // 各部位佔比 (%)，總和須為 100
            widths: [25, 25, 45, 40, 30, 40, 20], // 寬度 (相對單位 1-100)
            imgs: [null, null, null, null, null]
        };
    }

    let characters = [createDefaultChar("1")];
    let activeIdx = 0;

    /* 初始化 */
    function init() {
        renderTabs();
        loadControls();
        renderStage();
    }

    function renderTabs() {
        const container = document.getElementById('charTabs');
        container.innerHTML = characters.map((c, i) => `
            <div class="tab ${i === activeIdx ? 'active' : ''}" onclick="switchChar(${i})">${c.name}</div>
        `).join('');
    }

    function switchChar(idx) {
        activeIdx = idx;
        init();
    }

    function addPort() {
        const newChar = createDefaultChar("" + (characters.length + 1));
        newChar.posX = (characters.length) * 80;
        characters.push(newChar);
        activeIdx = characters.length - 1;
        init();
    }

    function delPort() {
        if (characters.length <= 1) return;
        characters.splice(activeIdx, 1);
        activeIdx = 0;
        init();
    }

    /* 載入控制項：範圍統一為 1~100 */
   

   
 function loadControls() {
    const c = characters[activeIdx];
    document.getElementById('controls').style.display = 'block';
    document.getElementById('posX').value = c.posX;
    document.getElementById('v-posX').innerText = c.posX;
    
    document.getElementById('totalH').value = c.targetH;
    document.getElementById('totalHNum').value = Math.round(c.targetH);
    
    document.getElementById('visibleCount').value = c.visible;
    document.getElementById('v-visible').innerText = c.visible;

    // 高度滑桿：從百分比改為 cm
    const hDiv = document.getElementById('heightSliders');
    hDiv.innerHTML = c.heights.map((h, i) => {
        const cmVal = (h / 100 * c.targetH).toFixed(0); // 計算當前 cm
        return `
            <div class="row" style="display: ${i < c.visible ? 'flex' : 'none'}">
                <label>${partNames[i]}</label>
                <input type="range" 
                    min="1" 
                    max="${c.targetH}" 
                    step="0.1" 
                    value="${cmVal}" 
                    class="h-slider" 
                    oninput="adjustPartHeightCM(${i}, this.value)">
                <span class="val-text">${cmVal}</span>
            </div>
        `;
    }).join('');
      
      


        // 寬度滑桿 (1-100)
        const wDiv = document.getElementById('widthSliders');
        wDiv.innerHTML = c.widths.map((w, i) => {
            let show = (i <= 1 && c.visible >= 1) || (i <= 3 && c.visible >= 2) || (i === 4 && c.visible >= 3) || (i === 5 && c.visible >= 4) || (i === 6 && c.visible >= 5);
            return `
                <div class="row" style="display: ${show ? 'flex' : 'none'}">
                    <label>${widthNames[i]}</label>
                    <input type="range" min="1" max="100" value="${w}" class="w-slider" oninput="updateCharWidth(${i}, this.value)">
                    <span class="val-text">${w}</span>
                </div>
            `;
        }).join('');

        const iDiv = document.getElementById('imgUploads');
        iDiv.innerHTML = partNames.map((name, i) => `
            <div class="row" style="display: ${i < c.visible ? 'flex' : 'none'}">
                <label>${name}</label><input type="file" style="font-size:10px" onchange="uploadImg(event, ${i})">
            </div>
        `).join('');
        updatePercentBar();
    }
   

         function adjustPartHeightCM(idx, newValCm) {
    const c = characters[activeIdx];
    // 將輸入的 cm 轉回百分比 (例如: 45cm / 180cm * 100 = 25%)
    const newValPercent = (parseFloat(newValCm) / c.targetH) * 100;
    
    // 呼叫原本處理百分比分配的邏輯
    adjustPartHeight(idx, newValPercent);
}
    


function syncUISliders() {
    const c = characters[activeIdx];
    const hSliders = document.querySelectorAll('.h-slider');
    const hTexts = document.querySelector('#heightSliders').querySelectorAll('.val-text');
    
    c.heights.forEach((h, i) => {
        const cmVal = (h / 100 * c.targetH).toFixed(0);
        if (hSliders[i]) {
            hSliders[i].value = cmVal;
            hSliders[i].max = c.targetH; // 確保 max 隨總身高更新
        }
        if (hTexts[i]) hTexts[i].innerText = cmVal;
    });
    updatePercentBar();
}

    function updateCharBasic(key, val) {
        characters[activeIdx][key] = parseInt(val);
        document.getElementById('v-' + key).innerText = val;
        renderStage();
    }

    function updateVisibleCount(val) {
        characters[activeIdx].visible = parseInt(val);
        // 當可見部位改變，需重新分配百分比確保總和為 100
        const c = characters[activeIdx];
        const avg = 100 / c.visible;
        for(let i=0; i<5; i++) c.heights[i] = (i < c.visible) ? avg : 0;
        loadControls();
        renderStage();
    }

    /* 調整高度比例：確保可見部位總和永遠為 100% */
    function adjustPartHeight(idx, newVal) {
        newVal = parseFloat(newVal);
        const c = characters[activeIdx];
        const minVal = 1;
        
        // 限制最大值，確保其他部位至少有 1%
        const maxLimit = 100 - (c.visible - 1) * minVal;
        if (newVal > maxLimit) newVal = maxLimit;
        if (newVal < minVal) newVal = minVal;

        const oldVal = c.heights[idx];
        const delta = newVal - oldVal;
        const otherIndices = [];
        for (let i = 0; i < c.visible; i++) {
            if (i !== idx) otherIndices.push(i);
        }

        if (otherIndices.length > 0) {
            c.heights[idx] = newVal;
            const otherSum = otherIndices.reduce((sum, i) => sum + c.heights[i], 0);
            
            otherIndices.forEach((oi) => {
                const ratio = otherSum > 0 ? c.heights[oi] / otherSum : 1 / otherIndices.length;
                c.heights[oi] -= delta * ratio;
                if (c.heights[oi] < minVal) c.heights[oi] = minVal;
            });

            // 修正微小誤差確保總和必為 100
            const currentTotal = c.heights.slice(0, c.visible).reduce((a, b) => a + b, 0);
            const error = 100 - currentTotal;
            c.heights[otherIndices[otherIndices.length - 1]] += error;
        }
        syncUISliders();
        renderStage();
    }

    /* 更新總身高：現在只改數值，不影響部位比例 */
function updateTotalH(val) {
    if (val === "" || isNaN(val) || val <= 0) return;
    characters[activeIdx].targetH = parseFloat(val);
    document.getElementById('totalH').value = val;
    document.getElementById('totalHNum').value = Math.round(val);
    
    // 關鍵：重新加載控制項以更新滑桿的 max 值與 cm 顯示
    loadControls(); 
    renderStage();
}

    function updateCharWidth(i, val) {
        characters[activeIdx].widths[i] = parseInt(val);
        const wTexts = document.querySelector('#widthSliders').querySelectorAll('.val-text');
        if (wTexts[i]) wTexts[i].innerText = val;
        renderStage();
    }

    function updatePercentBar() {
        const c = characters[activeIdx];
        const bar = document.getElementById('percentBar');
        bar.innerHTML = c.heights.slice(0, c.visible).map((h, i) => {
            return `<div style="width:${h}%; background:${colors[i]}">${Math.round(h)}%</div>`;
        }).join('');
    }

    function uploadImg(e, partIdx) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                characters[activeIdx].imgs[partIdx] = ev.target.result;
                renderStage();
            };
            reader.readAsDataURL(file);
        }
    }

function renderStage() {
    const stage = document.getElementById('stage');
    let maxDisplayH = 0;
    
    // 1. 清除舊有的角色容器與標籤
    const containers = stage.querySelectorAll('.character-container');
    const labels = stage.querySelectorAll('.height-label');
    containers.forEach(el => el.remove());
    labels.forEach(el => el.remove());

    const WIDTH_REF_H = 180;

    // 2. 第一次計算：找出所有角色的最高值以決定全域縮放比例
    characters.forEach((c) => {
        let charHPx = 0;
        for (let i = 0; i < c.visible; i++) {
            charHPx += (c.heights[i] / 100) * c.targetH * SCALE_BASE;
        }
        if (charHPx > maxDisplayH) maxDisplayH = charHPx;
    });

    const stageH = stage.clientHeight - 120;
    const scale = maxDisplayH > stageH ? stageH / maxDisplayH : 1;

    // 3. 第二次計算：渲染角色與獨立標籤
    characters.forEach((c, charIdx) => {
        const charDiv = document.createElement('div');
        charDiv.className = 'character-container';
        charDiv.style.left = `calc(50% + ${c.posX}px)`;
        charDiv.style.zIndex = charIdx;
        charDiv.style.transform = `translateX(-50%) scale(${scale})`; // 角色依比例縮放

        const widthScale = c.targetH / WIDTH_REF_H;
        for (let i = 0; i < c.visible; i++) {
            const part = document.createElement('div');
            part.className = 'part';
            let tw = ((i === 0) ? c.widths[0] : c.widths[i + 1]) * widthScale;
            let bw = ((i === 0) ? c.widths[1] : c.widths[i + 2]) * widthScale;
            const maxW = Math.max(tw, bw);
            const hPx = (c.heights[i] / 100) * c.targetH * SCALE_BASE;
            
            part.style.width = (maxW * SCALE_BASE) + 'px';
            part.style.height = hPx + 'px';

            if (c.imgs[i]) {
                part.style.background = `url(${c.imgs[i]}) no-repeat center/cover transparent`;
            } else {
                part.style.background = `${colors[i]}`;
            }

            const tP = ((maxW - tw) / 2 / maxW) * 100;
            const bP = ((maxW - bw) / 2 / maxW) * 100;
            part.style.clipPath = `polygon(${tP}% 0%, ${100-tP}% 0%, ${100-bP}% 100%, ${bP}% 100%)`;
            
            charDiv.appendChild(part);
        }
        stage.appendChild(charDiv);

        // --- 建立高度標籤 (放在角色下方) ---
        const label = document.createElement('div');
        label.className = 'height-label';
        label.innerText = `${Math.round(c.targetH)} cm`;
        
        // 關鍵定位：
        // 1. 水平與角色同步
        label.style.left = `calc(50% + ${c.posX}px)`;
        label.style.transform = `translateX(-50%)`; // 只做位移修正，不跟隨 scale
        
        // 2. 垂直定位在舞台底部 (假設腳底基準線在 bottom: 60px，標籤放更低)
        label.style.bottom = '20px'; 
        label.style.position = 'absolute';

        stage.appendChild(label);
    });

    document.getElementById('rulerbox').style.transform = `scale(${scale})`;
}  

    function retPort() {
        const name = characters[activeIdx].name;
        characters[activeIdx] = createDefaultChar(name);
        init();
    }

    window.onresize = renderStage;
    init();
</script>
</body>
</html>
